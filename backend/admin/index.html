<!doctype html>
<html lang="it">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Admin DP CARS</title>
  <style>
    body { font-family: Arial, sans-serif; max-width: 980px; margin: 20px auto; padding: 0 12px; }
    form { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; padding: 12px; border: 1px solid #ddd; border-radius: 8px; }
    form .full { grid-column: 1 / -1; }
    input, select, button, textarea { padding: 10px; font-size: 14px; }
    button { cursor: pointer; }
    table { width: 100%; border-collapse: collapse; margin-top: 16px; }
    th, td { border: 1px solid #ddd; padding: 8px; vertical-align: top; }
    img { width: 110px; height: 70px; object-fit: cover; border-radius: 6px; }
    .row-actions { display:flex; gap:8px; }
  </style>
</head>
<body>
  <h1>Admin veicoli - DP CARS</h1>
  <p id="status"></p>

  <form id="vehicleForm" enctype="multipart/form-data">
    <input type="hidden" name="id" id="id" />

    <select name="type" id="type" required>
      <option value="auto">Auto</option>
      <option value="moto">Moto</option>
    </select>

    <select name="status" id="statusField" required>
      <option value="available">Disponibile</option>
      <option value="reserved">Prenotata</option>
      <option value="sold">Venduta</option>
    </select>

    <input name="title" id="title" placeholder="Titolo (es. Fiat Panda 1.2 Lounge)" class="full" required />

    <input name="price" id="price" type="number" placeholder="Prezzo" required />
    <input name="year" id="year" type="number" placeholder="Anno" required />

    <input name="km" id="km" type="number" placeholder="Km" required />
    <input name="power" id="power" placeholder="Potenza (es. 110 CV)" required />

    <input name="fuel" id="fuel" placeholder="Alimentazione (Benzina/Diesel...)" required />
    <input name="transmission" id="transmission" placeholder="Cambio (Manuale/Automatico)" required />

    <input name="images" id="images" type="file" accept="image/*" multiple class="full" />
    <small style="color: #666;">Carica almeno 5 foto del veicolo</small>

    <button type="submit" class="full">Salva veicolo</button>
    <button type="button" id="resetBtn" class="full">Nuovo veicolo (reset)</button>
  </form>

  <h2>Elenco veicoli</h2>
  <table>
    <thead>
      <tr>
        <th>ID</th>
        <th>Foto</th>
        <th>Titolo</th>
        <th>Dati</th>
        <th>Azioni</th>
      </tr>
    </thead>
    <tbody id="rows"></tbody>
  </table>

  <script>
    const API = "http://localhost:3001";
    const form = document.getElementById("vehicleForm");
    const rows = document.getElementById("rows");
    const status = document.getElementById("status");
    const resetBtn = document.getElementById("resetBtn");

    function setStatus(msg) { 
      status.textContent = msg; 
      console.log("Status:", msg);
    }

    async function loadVehicles() {
      console.log("ðŸ”„ Caricamento veicoli...");
      try {
        const res = await fetch(`${API}/api/admin/vehicles`);
        const json = await res.json();
        console.log("âœ… Veicoli caricati:", json.data?.length);
        return json.data || [];
      } catch (error) {
        console.error("âŒ Errore caricamento:", error);
        return [];
      }
    }

    function render(vehicles) {
      console.log("ðŸŽ¨ Rendering", vehicles.length, "veicoli");
      rows.innerHTML = "";
      vehicles.forEach(v => {
        const tr = document.createElement("tr");
        const img = (v.images && v.images[0]) ? `${API}${v.images[0]}` : "";
        tr.innerHTML = `
          <td>${v.id}</td>
          <td>${img ? `<img src="${img}" alt="">` : ""}</td>
          <td>${v.title || ""}</td>
          <td>
            ${v.type || ""} - ${v.status || ""}<br>
            â‚¬ ${Number(v.price || 0).toLocaleString("it-IT")}<br>
            ${v.year || ""} - ${Number(v.km || 0).toLocaleString("it-IT")} km
          </td>
          <td>
            <div class="row-actions">
              <button class="btn-edit" data-id="${v.id}">Modifica</button>
              <button class="btn-delete" data-id="${v.id}">Elimina</button>
            </div>
          </td>
        `;
        rows.appendChild(tr);
      });

      document.querySelectorAll('.btn-delete').forEach(btn => {
        btn.addEventListener('click', handleDelete);
      });

      document.querySelectorAll('.btn-edit').forEach(btn => {
        btn.addEventListener('click', handleEdit);
      });
    }

    async function handleDelete(e) {
      const id = e.target.getAttribute('data-id');
      console.log("ðŸ—‘ï¸ Click elimina, ID:", id);
      
      if (!confirm(`Eliminare il veicolo ${id}?`)) {
        console.log("âŒ Eliminazione annullata");
        return;
      }

      setStatus("Eliminazione in corso...");
      
      try {
        console.log(`ðŸ”„ Invio DELETE a ${API}/api/admin/vehicles/${id}`);
        const res = await fetch(`${API}/api/admin/vehicles/${id}`, { 
          method: "DELETE"
        });
        
        console.log("ðŸ“© Risposta ricevuta, status:", res.status);
        
        if (!res.ok) { 
          const err = await res.json().catch(() => ({}));
          setStatus("Errore eliminazione: " + (err.error || res.statusText)); 
          return; 
        }
        
        const result = await res.json();
        console.log("âœ… Risultato:", result);
        
        setStatus("Veicolo eliminato!");
        await refresh();
        
      } catch (error) {
        console.error("âŒ Errore catturato:", error);
        setStatus("Errore: " + error.message);
      }
    }

    async function handleEdit(e) {
      const id = e.target.getAttribute('data-id');
      console.log("âœï¸ Click modifica, ID:", id);
      const vehicles = await loadVehicles();
      const v = vehicles.find(x => String(x.id) === String(id));
      if (v) {
        fillForm(v);
        setStatus("Modifica veicolo " + id);
      }
    }

    function fillForm(v) {
      document.getElementById("id").value = v.id;
      document.getElementById("type").value = v.type || "auto";
      document.getElementById("statusField").value = v.status || "available";
      document.getElementById("title").value = v.title || "";
      document.getElementById("price").value = v.price ?? "";
      document.getElementById("year").value = v.year ?? "";
      document.getElementById("km").value = v.km ?? "";
      document.getElementById("fuel").value = v.fuel || "";
      document.getElementById("transmission").value = v.transmission || "";
      document.getElementById("power").value = v.power || "";
    }

    async function refresh() {
      const vehicles = await loadVehicles();
      render(vehicles);
      return vehicles;
    }

    form.addEventListener("submit", async (e) => {
      e.preventDefault();
      
      setStatus("Controllo foto...");
      
      const fileInput = document.getElementById("images");
      const files = fileInput.files;
      
      console.log("ðŸ“¸ Numero foto selezionate:", files.length);
      
      if (files.length > 0 && files.length < 5) {
        setStatus("âŒ Errore: hai selezionato solo " + files.length + " foto!");
        alert(`Hai selezionato solo ${files.length} foto. Devi caricarne almeno 5.`);
        return;
      }
      
      if (files.length === 0 && !document.getElementById("id").value) {
        setStatus("âŒ Errore: devi caricare almeno 5 foto!");
        alert("Devi caricare almeno 5 foto del veicolo");
        return;
      }
      
      setStatus("Salvataggio in corso...");

      const fd = new FormData(form);

      try {
        console.log(`ðŸ“¤ Invio POST con ${files.length} foto`);
        const res = await fetch(`${API}/api/admin/vehicles`, {
          method: "POST",
          body: fd
        });

        if (!res.ok) {
          const err = await res.json().catch(() => ({}));
          setStatus("Errore: " + (err.error || res.statusText));
          return;
        }

        const result = await res.json();
        console.log("âœ… Risposta:", result);
        
        setStatus(`Veicolo salvato con ${files.length} foto!`);
        form.reset();
        document.getElementById("id").value = "";
        await refresh();
      } catch (error) {
        console.error("Errore POST:", error);
        setStatus("Errore: " + error.message);
      }
    });

    resetBtn.addEventListener("click", () => {
      form.reset();
      document.getElementById("id").value = "";
      setStatus("Form resettato.");
    });

    refresh().then(() => setStatus("Pronto."));
  </script>
</body>
</html>
